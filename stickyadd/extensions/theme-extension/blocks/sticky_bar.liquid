{% if request.page_type == 'product' and product %}

{% assign theme_style = block.settings.color_scheme | default: 'dark' %}
{% assign is_glassy = block.settings.enable_glassy | default: true %}
{% assign app_url = shop.metafields.stickyadd.app_url %}

{% comment %}
  Colors based on scheme
{% endcomment %}
{% if theme_style == 'dark' %}
  {% assign bg_color = '#000000' %}
  {% assign text_color = '#ffffff' %}
  {% assign bg_opacity = '0.85' %}
  {% assign border_color = 'rgba(255,255,255,0.1)' %}
{% else %}
  {% assign bg_color = '#ffffff' %}
  {% assign text_color = '#000000' %}
  {% assign bg_opacity = '0.85' %}
  {% assign border_color = 'rgba(0,0,0,0.1)' %}
{% endif %}

<style>
  :root {
    --sticky-bar-bg: {{ bg_color }};
    --sticky-bar-text: {{ text_color }};
    --sticky-bar-btn-bg: #2563eb; /* Bright Blue */
    --sticky-bar-btn-text: #ffffff;
    --sticky-bar-border: {{ border_color }};
  }

  .sticky-cart-wrapper {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(200%);
    z-index: 9999;
    width: auto;
    max-width: 95%;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
  }

  .sticky-cart-wrapper.is-visible {
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }

  .sticky-cart-bar {
    display: flex;
    align-items: center;
    gap: 24px;
    padding: 12px;
    background-color: var(--sticky-bar-bg);
    color: var(--sticky-bar-text);
    border-radius: 9999px; /* Pill shape */
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    border: 1px solid var(--sticky-bar-border);
  }

  {% if is_glassy %}
  .sticky-cart-bar {
    background-color: rgba({{ bg_color | color_to_rgb | remove: 'rgb(' | remove: ')' }}, {{ bg_opacity }});
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  {% endif %}

  /* Product Info */
  .sticky-product-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .sticky-img {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    background: #fff;
    padding: 2px; /* Optional: mimics the white border look if needed */
  }

  .sticky-details {
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.3;
  }

  .sticky-title {
    font-size: 14px;
    font-weight: 700;
    white-space: nowrap;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sticky-price {
    font-size: 13px;
    opacity: 0.8;
  }

  /* Controls */
  .sticky-controls {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .sticky-qty {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: monospace, sans-serif;
    font-size: 14px;
  }

  .sticky-qty-btn {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    opacity: 0.6;
    transition: opacity 0.2s;
  }
  .sticky-qty-btn:hover { opacity: 1; }

  .sticky-qty-val {
    width: 20px;
    text-align: center;
    font-weight: 600;
  }

  .sticky-add-btn {
    background-color: var(--sticky-bar-btn-bg);
    color: var(--sticky-bar-btn-text);
    border: none;
    padding: 10px 24px;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.2s;
    white-space: nowrap;
  }

  .sticky-add-btn:hover {
    transform: scale(1.02);
    opacity: 0.95;
  }

  .sticky-add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Variant Select (Hidden but functional or minimal) */
  .sticky-variant-select {
    max-width: 100px;
    background: transparent;
    color: inherit;
    border: 1px solid var(--sticky-bar-border);
    border-radius: 4px;
    padding: 2px;
    font-size: 11px;
    margin-top: 2px;
  }

  @media (max-width: 768px) {
    .sticky-cart-bar {
      padding: 10px;
      gap: 12px;
      width: 90vw;
      justify-content: space-between;
    }
    .sticky-title { max-width: 120px; font-size: 13px; }
    .sticky-img { width: 40px; height: 40px; }
    .sticky-qty { display: none; } /* Hide qty on mobile to fit */
    .sticky-add-btn { padding: 8px 16px; font-size: 13px; }
  }
</style>

<div id="sticky-cart-wrapper" class="sticky-cart-wrapper" aria-hidden="true">
  <div class="sticky-cart-bar">
    
    <!-- Left: Image & Info -->
    <div class="sticky-product-info">
      {% if product.featured_image %}
        <img src="{{ product.featured_image | image_url: width: 100 }}" alt="{{ product.title }}" class="sticky-img" width="48" height="48">
      {% endif %}
      
      <div class="sticky-details">
        <span class="sticky-title">{{ product.title }}</span>
        <span class="sticky-price">{{ product.selected_or_first_available_variant.price | money }}</span>
        
        {% unless product.has_only_default_variant %}
          <select id="sticky-variant-select" class="sticky-variant-select">
            {% for variant in product.variants %}
              <option value="{{ variant.id }}" {% if variant == product.selected_or_first_available_variant %}selected{% endif %}>
                {{ variant.title }}
              </option>
            {% endfor %}
          </select>
        {% endunless %}
      </div>
    </div>

    <!-- Right: Qty & Button -->
    <div class="sticky-controls">
      <div class="sticky-qty">
        <button type="button" class="sticky-qty-btn minus" aria-label="Decrease">－</button>
        <span class="sticky-qty-val">1</span>
        <button type="button" class="sticky-qty-btn plus" aria-label="Increase">＋</button>
      </div>

      <form method="post" action="/cart/add" id="sticky-atc-form" style="margin:0;">
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
        <input type="hidden" name="properties[_attribution]" value="stickyadd">
        <input type="hidden" name="quantity" value="1" id="sticky-form-qty">
        
        <button type="submit" class="sticky-add-btn" {% unless product.available %}disabled{% endunless %}>
          {% if product.available %}
            Add to cart
          {% else %}
            Sold Out
          {% endif %}
        </button>
      </form>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const wrapper = document.getElementById('sticky-cart-wrapper');
  const form = document.getElementById('sticky-atc-form');
  const variantSelect = document.getElementById('sticky-variant-select');
  const qtyVal = wrapper.querySelector('.sticky-qty-val');
  const qtyInput = document.getElementById('sticky-form-qty');
  const idInput = form.querySelector('input[name="id"]');
     ({% for variant in product.variants %}
        {
          id: {{ variant.id }},
          price: "{{ variant.price | money }}",
          available: {{ variant.available }}
        },
      {% endfor %}
    ];

    variantSelect.addEventListener('change', (e) => {
      const id = parseInt(e.target.value);
      idInput.value = id;
      
      // Update Price
      const selected = variants.find(v => v.id === id);
      if (selected) {
        priceDisplay.textContent = selected.price;
        const btn = form.querySelector('button');
        if (selected.available) {
          btn.disabled = false;
          btn.textContent = 'Add to cart';
        } else {
          btn.disabled = true;
          btn.textContent = 'Sold Out';
        }
      }
    });
  }

  // AJAX Add to Cart
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = form.querySelector('button');
    const originalText = btn.textContent;
    btn.textContent = 'Adding...';
    btn.disabled = true;

    try {
      const formData = new FormData(form);
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      });
      
      if (res.ok) {
        btn.textContent = 'Added!';
        // Refresh cart bubble/drawer if theme supports it
        document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true })); 
        // Some themes use different events, try standard ones
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
      } else {
        const data = await res.json();
        alert(data.description || 'Error adding to cart');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      btn.textContent = 'Error';
      setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
    }t();
    sendEven'click'
  });
});
</script>

{% endif %}

{% schema %}
{
  "name": "Sticky Bar (Design)",
  "target": "body",
  "settings": [
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "options": [
        { "value": "dark", "label": "Dark" },
        { "value": "light", "label": "Light" }
      ],
      "default": "dark"
    },
    {
      "type": "checkbox",
      "id": "enable_glassy",
      "label": "Enable Glassy Effect",
      "default": true
    }
  ]
}
{% endschema %}
